# Tests for CT TFA benefit calculation
# Benefit = payment_standard - countable_unearned_income
# High earner (>= 171% FPG): 20% reduction

- name: Case 1, below 171 percent FPG, no reduction.
  period: 2024-01
  absolute_error_margin: 0.3
  input:
    ct_tfa_eligible: true
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 0
    tanf_gross_earned_income: 3_500
    state_code: CT
  output:
    # 0.73 * 0.55 * (24,860/12) = 831.77
    ct_tfa_payment_standard: 831.77
    ct_tfa: 831.77

- name: Case 2, above 171 percent FPG, gets 20 percent reduction.
  period: 2024-01
  absolute_error_margin: 0.3
  input:
    ct_tfa_eligible: true
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 0
    tanf_gross_earned_income: 3_600
    state_code: CT
  output:
    ct_tfa_payment_standard: 831.77
    # 831.77 * 0.8 = 665.42
    ct_tfa: 665.42

- name: Case 3, unearned income deducted from payment.
  period: 2024-01
  absolute_error_margin: 0.3
  input:
    ct_tfa_eligible: true
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 200
    tanf_gross_earned_income: 1_000
    state_code: CT
  output:
    ct_tfa_payment_standard: 831.77
    # 831.77 - 200 = 631.77
    ct_tfa: 631.77

- name: Case 4, unearned income exceeds payment, benefit zero.
  period: 2024-01
  absolute_error_margin: 0.3
  input:
    ct_tfa_eligible: true
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 900
    tanf_gross_earned_income: 500
    state_code: CT
  output:
    ct_tfa_payment_standard: 831.77
    # max(831.77 - 900, 0) = 0
    ct_tfa: 0

- name: Case 5, high earner with unearned income.
  period: 2024-01
  absolute_error_margin: 0.3
  input:
    ct_tfa_eligible: true
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 133
    tanf_gross_earned_income: 3_600
    state_code: CT
  output:
    ct_tfa_payment_standard: 831.77
    # (831.77 - 133) * 0.8 = 698.77 * 0.8 = 559.02
    ct_tfa: 559.02

- name: Case 6, high earner with unearned exceeding payment, zero floor.
  period: 2024-01
  absolute_error_margin: 0.3
  input:
    ct_tfa_eligible: true
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 900
    tanf_gross_earned_income: 3_600
    state_code: CT
  output:
    ct_tfa_payment_standard: 831.77
    # max(831.77 - 900, 0) * 0.8 = 0
    ct_tfa: 0

- name: Case 7, not eligible.
  period: 2024-01
  absolute_error_margin: 0.1
  input:
    ct_tfa_eligible: false
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 100
    tanf_gross_earned_income: 500
    state_code: CT
  output:
    ct_tfa: 0

# --- Pre-2024 test (before high-earnings provision took effect) ---
# The high_earnings/in_effect parameter is false before 2024-01-01. The formula
# uses an if-check (p.high_earnings.in_effect) so the reduction does not apply
# before 2024.

- name: Case 8, 2023 statewide formula uses 2022 FPG.
  period: 2023-01
  absolute_error_margin: 0.3
  input:
    ct_tfa_eligible: true
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 0
    tanf_gross_earned_income: 1_000
    state_code: CT
  output:
    # 0.73 * 0.55 * (23,030/12) = 0.4015 * 1,919.17 = 770.55
    ct_tfa_payment_standard: 770.55
    ct_tfa: 770.55

# --- Regional period benefit test (pre-2022) ---

- name: Case 9, 2020 regional period Region B benefit.
  period: 2020-01
  absolute_error_margin: 0.1
  input:
    ct_tfa_eligible: true
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 0
    tanf_gross_earned_income: 500
    state_code: CT
  output:
    # Region B (default), size 3 = $597
    ct_tfa_payment_standard: 597
    ct_tfa: 597

- name: Case 10, 2020 regional period Region A with unearned income.
  period: 2020-01
  absolute_error_margin: 0.1
  input:
    ct_tfa_eligible: true
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 100
    tanf_gross_earned_income: 200
    ct_tfa_region: REGION_A
    state_code: CT
  output:
    # Region A, size 3 = $698
    ct_tfa_payment_standard: 698
    # 698 - 100 = 598
    ct_tfa: 598

# --- Housing subsidy tests (CGS ยง 17b-104(d)) ---
# Families in subsidized housing receive 92% of payment standard.

- name: Case 11, housing subsidy reduces payment standard.
  period: 2024-01
  absolute_error_margin: 0.3
  input:
    ct_tfa_eligible: true
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 0
    tanf_gross_earned_income: 1_000
    receives_housing_assistance: true
    state_code: CT
  output:
    ct_tfa_payment_standard: 831.77
    # 831.77 * 0.92 = 765.23
    ct_tfa: 765.23

- name: Case 12, housing subsidy with unearned income.
  period: 2024-01
  absolute_error_margin: 0.3
  input:
    ct_tfa_eligible: true
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 200
    tanf_gross_earned_income: 1_000
    receives_housing_assistance: true
    state_code: CT
  output:
    ct_tfa_payment_standard: 831.77
    # 831.77 * 0.92 - 200 = 765.23 - 200 = 565.23
    ct_tfa: 565.23

- name: Case 13, housing subsidy with high earner reduction.
  period: 2024-01
  absolute_error_margin: 0.3
  input:
    ct_tfa_eligible: true
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 0
    tanf_gross_earned_income: 3_600
    receives_housing_assistance: true
    state_code: CT
  output:
    ct_tfa_payment_standard: 831.77
    # 831.77 * 0.92 = 765.23, then * 0.8 = 612.18
    ct_tfa: 612.18

# --- Housing subsidy edge cases ---

- name: Case 14, housing subsidy in 2020 regional period.
  period: 2020-01
  absolute_error_margin: 0.3
  input:
    ct_tfa_eligible: true
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 0
    tanf_gross_earned_income: 500
    receives_housing_assistance: true
    state_code: CT
  output:
    # Region B (default), size 3 = $597
    ct_tfa_payment_standard: 597
    # 597 * 0.92 = 549.24
    ct_tfa: 549.24

- name: Case 15, unearned exceeds housing-adjusted standard, zero floor.
  period: 2024-01
  absolute_error_margin: 0.3
  input:
    ct_tfa_eligible: true
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 800
    tanf_gross_earned_income: 500
    receives_housing_assistance: true
    state_code: CT
  output:
    ct_tfa_payment_standard: 831.77
    # 831.77 * 0.92 = 765.23; max(765.23 - 800, 0) = 0
    ct_tfa: 0

- name: Case 16, unearned exceeds regional payment standard, zero floor.
  period: 2020-01
  absolute_error_margin: 0.1
  input:
    ct_tfa_eligible: true
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 650
    tanf_gross_earned_income: 0
    state_code: CT
  output:
    # Region B (default), size 3 = $597
    ct_tfa_payment_standard: 597
    # max(597 - 650, 0) = 0
    ct_tfa: 0

# --- Boundary: earnings at exact 171% FPG threshold ---

- name: Case 17, earnings clearly above 171 percent FPG threshold.
  period: 2024-01
  absolute_error_margin: 0.3
  input:
    ct_tfa_eligible: true
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 0
    tanf_gross_earned_income: 3_543
    state_code: CT
  output:
    ct_tfa_payment_standard: 831.77
    # 3,543 >= 1.71 * 2,071.67 = 3,542.55 triggers high earner reduction
    # 831.77 * 0.8 = 665.42
    ct_tfa: 665.42

# --- Pre-2024: high earner with no reduction (in_effect = false) ---

- name: Case 18, 2023 high earner, no reduction applied.
  period: 2023-01
  absolute_error_margin: 0.3
  input:
    ct_tfa_eligible: true
    spm_unit_size: 3
    ct_tfa_countable_unearned_income: 0
    tanf_gross_earned_income: 4_000
    state_code: CT
  output:
    # 0.73 * 0.55 * (23,030 / 12) = 0.4015 * 1,919.17 = 770.55
    ct_tfa_payment_standard: 770.55
    # high_earnings/in_effect is false before 2024, so no 20% reduction
    ct_tfa: 770.55
